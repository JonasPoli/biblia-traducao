{% extends 'admin/base.html.twig' %}

{% block title %}{{ book.name }} {{ chapter }}:{{ verse.verse }} - Detalhes{% endblock %}

{% block body %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8 flex items-center gap-4">
        <a href="{{ path('app_translation_chapter', {bookId: book.id, chapter: chapter}) }}" class="text-blue-600 hover:text-blue-800">
            &larr; Voltar para Capítulo
        </a>
        <h1 class="text-3xl font-bold text-gray-800">{{ book.name }} {{ chapter }}:{{ verse.verse }}</h1>
    </div>

    {# Translation Section #}
    <div class="bg-white rounded-lg shadow-md p-6 border border-gray-100 mb-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="space-y-4">
                {% if texts.original %}
                    <div class="bg-gray-50 p-4 rounded border border-gray-200">
                        <h3 class="text-xs font-semibold text-gray-500 uppercase mb-2">Original</h3>
                        <p class="font-serif text-lg leading-relaxed">{{ texts.original.text|raw }}</p>
                    </div>
                {% endif %}
                
                {% if almeidaHtml %}
                    <div class="bg-yellow-50 p-4 rounded border border-yellow-200">
                        <h3 class="text-xs font-semibold text-yellow-600 uppercase mb-2">Almeida (Strong)</h3>
                        <p class="font-serif text-lg leading-relaxed">{{ almeidaHtml|raw }}</p>
                    </div>
                {% endif %}

                {% if texts.reference %}
                    <div class="bg-blue-50 p-4 rounded border border-blue-100">
                        <h3 class="text-xs font-semibold text-blue-500 uppercase mb-2">Referência</h3>
                        <p class="text-gray-800 leading-relaxed">{{ texts.reference.text|raw }}</p>
                    </div>
                {% endif %}
            </div>

            <div>
                <h3 class="text-xs font-semibold text-green-600 uppercase mb-2">Sua Tradução</h3>
                <form 
                    action="{{ path('app_translation_save', {id: verse.id}) }}" 
                    method="POST"
                    data-controller="translation"
                    data-action="submit->translation#save"
                >
                    <div class="mb-4">
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Assunto</label>
                        <input 
                            type="text" 
                            name="title" 
                            value="{{ texts.target ? texts.target.title : '' }}"
                            class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
                            placeholder="Assunto do versículo..."
                        >
                    </div>

                    <textarea 
                        name="text" 
                        rows="6" 
                        class="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-transparent mb-2 font-medium text-gray-900 tinymce"
                        placeholder="Digite a tradução aqui..."
                    >{{ texts.target ? texts.target.text|raw : '' }}</textarea>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500" data-translation-target="status"></span>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition-colors">
                            Salvar Tradução
                        </button>
                    </div>
                </form>

                {# References Section #}
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase mb-4">Referências Cruzadas</h3>
                    
                    {# Specific References #}
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-sm font-semibold text-gray-700">Específicas</h4>
                            <button onclick="document.getElementById('add-specific-ref-modal').showModal()" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200">
                                + Adicionar
                            </button>
                        </div>
                        <div class="space-y-2">
                            {% for ref in references %}
                                <div class="bg-gray-50 p-3 rounded text-sm flex justify-between items-start group border border-gray-200">
                                    <div>
                                        <span class="font-bold text-gray-700 block">{{ ref.term }}</span>
                                        <span class="text-gray-600">{{ ref.referenceText|raw }}</span>
                                    </div>
                                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="openEditSpecificModal('{{ ref.id }}', '{{ ref.term|escape('js') }}', '{{ ref.referenceText|escape('js') }}')" class="text-blue-500 hover:text-blue-700">
                                            <sl-icon name="pencil"></sl-icon>
                                        </button>
                                        <form action="{{ path('app_translation_reference_delete', {id: ref.id}) }}" method="POST" onsubmit="return confirm('Tem certeza?');" class="inline">
                                            <button type="submit" class="text-red-400 hover:text-red-600">
                                                <sl-icon name="trash"></sl-icon>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            {% else %}
                                <p class="text-sm text-gray-400 italic">Nenhuma referência específica.</p>
                            {% endfor %}
                        </div>
                    </div>

                    {# Global References #}
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-sm font-semibold text-gray-700">Globais</h4>
                            <button onclick="document.getElementById('add-global-ref-modal').showModal()" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded hover:bg-purple-200">
                                + Adicionar
                            </button>
                        </div>
                        <div class="space-y-2">
                            {% for gRef in globalReferences %}
                                <div class="bg-purple-50 p-3 rounded text-sm flex justify-between items-start group border border-purple-100">
                                    <div>
                                        <span class="font-bold text-purple-900 block">{{ gRef.term }} <span class="text-xs font-normal text-purple-600">({{ gRef.foreignWord }})</span></span>
                                        <span class="text-purple-800">{{ gRef.referenceText|raw }}</span>
                                    </div>
                                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="openEditGlobalModal('{{ gRef.id }}', '{{ gRef.term|escape('js') }}', '{{ gRef.referenceText|escape('js') }}', '{{ gRef.foreignWord|escape('js') }}')" class="text-blue-500 hover:text-blue-700">
                                            <sl-icon name="pencil"></sl-icon>
                                        </button>
                                        <form action="{{ path('app_translation_global_reference_delete', {id: gRef.id}) }}" method="POST" onsubmit="return confirm('Tem certeza?');" class="inline">
                                            <input type="hidden" name="redirect_book_id" value="{{ book.id }}">
                                            <input type="hidden" name="redirect_chapter" value="{{ chapter }}">
                                            <input type="hidden" name="redirect_verse_num" value="{{ verse.verse }}">
                                            <button type="submit" class="text-red-400 hover:text-red-600">
                                                <sl-icon name="trash"></sl-icon>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            {% else %}
                                <p class="text-sm text-gray-400 italic">Nenhuma referência global ativa para este versículo.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                {# Modals #}
                <dialog id="add-specific-ref-modal" class="p-0 rounded-lg shadow-xl backdrop:bg-gray-900/50 w-full max-w-md">
                    <div class="p-6">
                        <h3 class="text-lg font-bold mb-4">Adicionar Referência Específica</h3>
                        <form action="{{ path('app_translation_reference_add', {verseId: verse.id}) }}" method="POST">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Termo</label>
                                    <input type="text" name="term" id="add-specific-term" class="w-full p-2 border rounded" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Referência</label>
                                    <textarea name="referenceText" id="add-specific-text" rows="3" class="w-full p-2 border rounded tinymce"></textarea>
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button type="button" onclick="document.getElementById('add-specific-ref-modal').close()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Salvar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </dialog>

                <dialog id="edit-specific-ref-modal" class="p-0 rounded-lg shadow-xl backdrop:bg-gray-900/50 w-full max-w-md">
                    <div class="p-6">
                        <h3 class="text-lg font-bold mb-4">Editar Referência Específica</h3>
                        <form id="edit-specific-form" method="POST">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Termo</label>
                                    <input type="text" name="term" id="edit-specific-term" class="w-full p-2 border rounded" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Referência</label>
                                    <textarea name="referenceText" id="edit-specific-text" rows="3" class="w-full p-2 border rounded tinymce"></textarea>
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button type="button" onclick="document.getElementById('edit-specific-ref-modal').close()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Salvar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </dialog>

                <dialog id="add-global-ref-modal" class="p-0 rounded-lg shadow-xl backdrop:bg-gray-900/50 w-full max-w-md">
                    <div class="p-6">
                        <h3 class="text-lg font-bold mb-4">Adicionar Referência Global</h3>
                        <form action="{{ path('app_translation_global_reference_add', {verseId: verse.id}) }}" method="POST">
                            <input type="hidden" name="strongId" id="add-global-strongId">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Termo</label>
                                    <input type="text" name="term" id="add-global-term" class="w-full p-2 border rounded" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Palavra Estrangeira (Filtro)</label>
                                    <input type="text" name="foreignWord" id="add-global-foreign" class="w-full p-2 border rounded">
                                    <p class="text-xs text-gray-500 mt-1">A referência só aparecerá se esta palavra estiver no texto original.</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Referência</label>
                                    <textarea name="referenceText" id="add-global-text" rows="3" class="w-full p-2 border rounded tinymce"></textarea>
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button type="button" onclick="document.getElementById('add-global-ref-modal').close()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">Salvar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </dialog>

                <dialog id="edit-global-ref-modal" class="p-0 rounded-lg shadow-xl backdrop:bg-gray-900/50 w-full max-w-md">
                    <div class="p-6">
                        <h3 class="text-lg font-bold mb-4">Editar Referência Global</h3>
                        <form id="edit-global-form" method="POST">
                            <input type="hidden" name="redirect_book_id" value="{{ book.id }}">
                            <input type="hidden" name="redirect_chapter" value="{{ chapter }}">
                            <input type="hidden" name="redirect_verse_num" value="{{ verse.verse }}">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Termo</label>
                                    <input type="text" name="term" id="edit-global-term" class="w-full p-2 border rounded" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Palavra Estrangeira (Filtro)</label>
                                    <input type="text" name="foreignWord" id="edit-global-foreign" class="w-full p-2 border rounded">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Referência</label>
                                    <textarea name="referenceText" id="edit-global-text" rows="3" class="w-full p-2 border rounded tinymce"></textarea>
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button type="button" onclick="document.getElementById('edit-global-ref-modal').close()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">Salvar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </dialog>

                <script>
                    function openAddGlobalModal(term, foreignWord, strongCode, transliteration, fullDefinition) {
                        document.getElementById('add-global-term').value = term;
                        document.getElementById('add-global-foreign').value = foreignWord;
                        document.getElementById('add-global-strongId').value = strongCode;
                        
                        const referenceContent = `<strong>${foreignWord}</strong>&nbsp;<em>(${transliteration})&nbsp;</em> ${fullDefinition}`;
                        
                        if (tinymce.get('add-global-text')) {
                            tinymce.get('add-global-text').setContent(referenceContent);
                        } else {
                            document.getElementById('add-global-text').value = referenceContent;
                        }
                        
                        document.getElementById('add-global-ref-modal').showModal();
                    }

                    function openAddSpecificModal(term, foreignWord, transliteration, fullDefinition) {
                        document.getElementById('add-specific-term').value = term;
                        
                        const referenceContent = `<strong>${foreignWord}</strong>&nbsp;<em>(${transliteration})&nbsp;</em> ${fullDefinition}`;
                        
                        if (tinymce.get('add-specific-text')) {
                            tinymce.get('add-specific-text').setContent(referenceContent);
                        } else {
                            document.getElementById('add-specific-text').value = referenceContent;
                        }
                        
                        document.getElementById('add-specific-ref-modal').showModal();
                    }

                    function openEditGlobalModal(id, term, text, foreign) {
                        document.getElementById('edit-global-form').action = '/admin/translation/global-reference/edit/' + id;
                        document.getElementById('edit-global-term').value = term;
                        document.getElementById('edit-global-foreign').value = foreign;
                        
                        // Set content in TinyMCE if initialized, otherwise set textarea value
                        if (tinymce.get('edit-global-text')) {
                            tinymce.get('edit-global-text').setContent(text);
                        } else {
                            document.getElementById('edit-global-text').value = text;
                        }
                        
                        document.getElementById('edit-global-ref-modal').showModal();
                    }
                    function openEditSpecificModal(id, term, text) {
                        document.getElementById('edit-specific-form').action = '/admin/translation/reference/edit/' + id;
                        document.getElementById('edit-specific-term').value = term;
                        
                        // Set content in TinyMCE if initialized, otherwise set textarea value
                        if (tinymce.get('edit-specific-text')) {
                            tinymce.get('edit-specific-text').setContent(text);
                        } else {
                            document.getElementById('edit-specific-text').value = text;
                        }
                        
                        document.getElementById('edit-specific-ref-modal').showModal();
                    }
                </script>
            </div>
        </div>
    </div>

            {# Tabs Section #}
            <div x-data="{ activeTab: 'chapter' }" class="bg-white rounded-lg shadow-md border border-gray-100 overflow-hidden">
                {# Tab Headers #}
                <div class="flex border-b overflow-x-auto js-tab-headers">
                    <button 
                        data-target="chapter"
                        class="js-tab-btn px-6 py-3 font-medium text-sm whitespace-nowrap transition-colors border-b-2 border-blue-600 text-blue-600"
                    >
                        Capítulo Original
                    </button>
                    {% for word in parsedWords %}
                        <button 
                            data-target="word-{{ loop.index }}"
                            class="js-tab-btn px-6 py-3 font-medium text-sm whitespace-nowrap transition-colors text-gray-500 hover:text-gray-700 text-center"
                        >
                            <div class="font-bold">{{ word.wordOriginal }}</div>
                            <div class="text-xs font-normal text-gray-400">({{ word.translation }})</div>
                        </button>
                    {% endfor %}
                </div>

                {# Tab Contents #}
                <div class="p-6">
                    {# Chapter Tab #}
                    <div id="tab-chapter" class="js-tab-content space-y-4">
                        <h3 class="text-lg font-bold mb-4">Comparativo do Capítulo</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Verso</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Original</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Almeida</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nova Tradução</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for row in chapterData %}
                                        <tr class="{{ row.verse.id == verse.id ? 'bg-yellow-50' : '' }}">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                <a href="{{ path('app_translation_verse', {bookId: book.id, chapter: chapter, verseNum: row.verse.verse}) }}" class="text-blue-600 hover:underline">
                                                    {{ row.verse.verse }}
                                                </a>
                                            </td>
                                            <td class="px-6 py-4 text-sm text-gray-500 font-serif">
                                                {% if row.original_html is defined %}
                                                    {{ row.original_html|raw }}
                                                {% else %}
                                                    {{ row.original ? row.original.text|raw : '-' }}
                                                {% endif %}
                                            </td>
                                            <td class="px-6 py-4 text-sm text-gray-500">
                                                {% if row.reference_html is defined %}
                                                    {{ row.reference_html|raw }}
                                                {% else %}
                                                    {{ row.reference ? row.reference.text|raw : '-' }}
                                                {% endif %}
                                            </td>
                                            <td class="px-6 py-4 text-sm text-gray-900 font-medium">{{ row.target ? row.target.text|raw : '-' }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                                <script>
                            document.addEventListener('DOMContentLoaded', () => {
                                const strongWords = document.querySelectorAll('.strong-word');
                                const footer = document.getElementById('strong-definition-footer');
                                const footerTitle = document.getElementById('strong-footer-title');
                                const footerTransliteration = document.getElementById('strong-footer-transliteration');
                                const footerDefinition = document.getElementById('strong-footer-definition');
                                
                                const strongDefinitions = {{ strongDefinitions|json_encode|raw }};
                                
                                strongWords.forEach(word => {
                                    word.addEventListener('mouseenter', () => {
                                        const strongId = word.dataset.strong;
                                        if (strongId) {
                                            // Highlight
                                            document.querySelectorAll(`.strong-word[data-strong="${strongId}"]`).forEach(el => {
                                                el.classList.add('bg-yellow-200', 'text-gray-900');
                                            });

                                            // Show Footer Definition
                                            if (strongDefinitions[strongId]) {
                                                const def = strongDefinitions[strongId];
                                                footerTitle.textContent = def.title || '';
                                                
                                                let metaText = '';
                                                if (def.transliteration) metaText += `<span class="italic">${def.transliteration}</span>`;
                                                if (def.pronunciation) metaText += ` • <span class="text-gray-500">${def.pronunciation}</span>`;
                                                if (def.lemma) metaText += ` • <span class="font-serif">${def.lemma}</span>`;
                                                footerTransliteration.innerHTML = metaText;

                                                let defHtml = '';
                                                if (def.definition) defHtml += `<div class="mb-2 font-medium">${def.definition}</div>`;
                                                if (def.fullDefinition) defHtml += `<div>${def.fullDefinition}</div>`;
                                                footerDefinition.innerHTML = defHtml;
                                                
                                                footer.classList.remove('translate-y-full');
                                            }
                                        }
                                    });
                                    
                                    word.addEventListener('mouseleave', () => {
                                        const strongId = word.dataset.strong;
                                        if (strongId) {
                                            // Remove Highlight
                                            document.querySelectorAll(`.strong-word[data-strong="${strongId}"]`).forEach(el => {
                                                el.classList.remove('bg-yellow-200', 'text-gray-900');
                                            });
                                            
                                            // Hide Footer
                                            footer.classList.add('translate-y-full');
                                        }
                                    });
                                });
                            });
                        </script>
                    </div>

                    {# Strong Definition Footer #}
                    <div id="strong-definition-footer" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg transform translate-y-full transition-transform duration-300 z-50 p-4 max-h-64 overflow-y-auto">
                        <div class="max-w-7xl mx-auto">
                            <h4 id="strong-footer-title" class="text-xl font-bold text-gray-900"></h4>
                            <p id="strong-footer-transliteration" class="text-gray-600 italic mb-2"></p>
                            <div id="strong-footer-definition" class="text-sm text-gray-800"></div>
                        </div>
                    </div>
                    {# Word Tabs #}
                    {% for word in parsedWords %}
                        <div id="tab-word-{{ loop.index }}" class="js-tab-content" style="display: none;">
                            <div class="word-detail-container" data-strong="{{ word.strongCode }}" data-loaded="false">
                                <div class="flex justify-center items-center py-12">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                    <span class="ml-2 text-gray-500">Carregando detalhes...</span>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div style="height: 500px;"></div>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('.js-tab-btn');
            const contents = document.querySelectorAll('.js-tab-content');

            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = 'tab-' + btn.dataset.target;

                    // Reset buttons
                    buttons.forEach(b => {
                        b.classList.remove('border-b-2', 'border-blue-600', 'text-blue-600');
                        b.classList.add('text-gray-500', 'hover:text-gray-700');
                    });

                    // Hide contents
                    contents.forEach(c => c.style.display = 'none');

                    // Activate button
                    btn.classList.remove('text-gray-500', 'hover:text-gray-700');
                    btn.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');

                    // Show content
                    const targetContent = document.getElementById(targetId);
                    if (targetContent) {
                        targetContent.style.display = 'block';
                        
                        // Load data if it's a word tab and not loaded
                        const container = targetContent.querySelector('.word-detail-container');
                        if (container && container.dataset.loaded === 'false') {
                            const strongCode = container.dataset.strong;
                            if (strongCode) {
                                fetch(`/api/word-detail/${strongCode}`)
                                    .then(response => response.text())
                                    .then(html => {
                                        container.innerHTML = html;
                                        container.dataset.loaded = 'true';
                                    })
                                    .catch(err => {
                                        container.innerHTML = '<p class="text-red-500 text-center py-4">Erro ao carregar detalhes.</p>';
                                        console.error(err);
                                    });
                            } else {
                                container.innerHTML = '<p class="text-gray-500 text-center py-4">Sem código Strong associado.</p>';
                                container.dataset.loaded = 'true';
                            }
                        }
                    }
                });
            });
            
            // Activate first tab
            if (buttons.length > 0) {
                buttons[0].click();
            }
        });
        </script>
{% endblock %}
